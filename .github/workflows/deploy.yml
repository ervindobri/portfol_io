name: Deploy Flutter Web to GitHub Pages Repo

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout source repo ---
      - name: Checkout source repository
        uses: actions/checkout@v4

      # --- Install Flutter and build ---
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Build Flutter Web
        run: flutter build web --release

      # --- Upload build folder as artifact ---
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-release
          path: build/web

      # --- Download artifact so docker-based actions can access it ---
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: web-release
          path: build/web   # ensures folder exists again

      # --- Debug (optional) ---
      - name: Debug workspace
        run: ls -R .

      # --- Push to external repo ---
      - name: Push generated webpage to another repository
        uses: nkoppel/push-files-to-another-repository@v1.1.4
        env:
          API_TOKEN_GITHUB: ${{ secrets.TARGET_REPO_TOKEN }}
        with:
          source-files: 'build/web/**'
          destination-username: 'ervindobri'
          destination-repository: 'ervindobri.github.io'
          destination-directory: 'portfolio/web'
          destination-branch: 'gh-pages'
          commit-email: 'ervindobri@gmail.com'
          commit-message: "Auto-update portfolio from main"
